events {}

http {


    upstream admin-backend {
        server admin-service:8080;
    }

    upstream inventory-backend {
        server inventory-service:8081;
    }

    upstream products-backend {
        server product-catalog-service:8082;
    }

    upstream orders-backend {
        server order-management-service:8084;
    }

    upstream data-access-backend {
        server data-access-service:8085;
    }

    upstream auth-backend {
        server auth-service:8086;
    }

    server {
        listen 80;

        # Admin routes are handled by the general /admin/ location below

        # Admin routes - all admin routes go to admin-backend
        location /admin/ {
            auth_request /auth/check;
            proxy_pass http://admin-backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
            error_page 403 = @error403;
        }

        # Authentication routes
        location ~ ^/(login|register|logout) {
            proxy_pass http://auth-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Session cookie handling
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
        }

        # Protected inventory endpoint - auth-service will handle authentication check
        location /inventory {
            # Auth check is handled by auth-service
            auth_request /auth/check;
            # If authenticated, proxy to inventory service
            proxy_pass http://inventory-backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Session cookie handling
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;

            # If not authenticated, redirect to login
            error_page 401 = @error401;
        }

        # Authentication check endpoint
        location = /auth/check {
            internal;
            proxy_pass http://auth-backend/auth/check;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;

            # Preserve the session cookie
            proxy_pass_header Set-Cookie;
        }



        # Get current user endpoint
        location = /auth/user {
            proxy_pass http://auth-backend/auth/user;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
        }

        # Handle 401 errors by redirecting to login
        location @error401 {
            return 302 /login;
        }

        # Handle 403 errors by redirecting to home with an access denied message
        location @error403 {
            return 302 /home?error=access_denied;
        }

        # Root location - protected by auth
        location = / {
            auth_request /auth/check;
            proxy_pass http://products-backend/;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }

        # Home location - protected by auth
        location = /home {
            auth_request /auth/check;
            proxy_pass http://products-backend/;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }



        # Handle both GET and POST requests for farmers page and its subpaths
        location ~ ^/farmers(/.*)?$ {
            auth_request /auth/check;
            proxy_pass http://inventory-backend;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }

        location /products/ {
            auth_request /auth/check;
            proxy_pass http://products-backend/;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }

        location /orders/ {
            auth_request /auth/check;
            proxy_pass http://orders-backend/;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }

        location /orders {
            auth_request /auth/check;
            proxy_pass http://orders-backend;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }

        location /data/ {
            auth_request /auth/check;
            proxy_pass http://data-access-backend/api/data/;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }

        # Updated catalog and checkout locations - protected by auth
        location ~ ^/(catalog|checkout) {
            auth_request /auth/check;
            proxy_pass http://products-backend;

            # Standard proxy settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / /;
            proxy_cookie_domain localhost $host;
            error_page 401 = @error401;
        }
    }
}
