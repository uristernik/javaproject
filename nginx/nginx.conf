events {}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    upstream admin-backend {
        server admin-service:8080;
    }

    upstream inventory-backend {
        server inventory-service:8081;
    }

    upstream products-backend {
        server product-catalog-service:8082;
    }

    upstream users-backend {
        server user-management-service:8083;
    }

    upstream orders-backend {
        server order-management-service:8084;
    }

    server {
        listen 80;

        # Default route to login page
        location = / {
            return 302 /api/auth/login-page;
        }

        # User Management Service routes
        location /api/auth/ {
            proxy_pass http://users-backend/api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /login {
            proxy_pass http://users-backend/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /register {
            proxy_pass http://users-backend/register;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Admin Service
        location /admin {
            rewrite ^/admin$ /admin/ permanent;
        }

        location /admin/ {
            proxy_pass http://admin-backend/;
        }

        # Inventory Service
        location /inventory {
            rewrite ^/inventory$ /inventory/ permanent;
        }

        location /inventory/ {
            proxy_pass http://inventory-backend/;
        }

        # Products Service
        location /products {
            rewrite ^/products$ /products/ permanent;
        }

        location /products/ {
            proxy_pass http://products-backend/;
        }

        # Orders Service
        location /orders {
            rewrite ^/orders$ /orders/ permanent;
        }

        location /orders/ {
            proxy_pass http://orders-backend/;
        }

        # Handle favicon.ico
        location = /favicon.ico {
            return 204;
            access_log off;
            log_not_found off;
        }

        # Error handling
        error_page 404 /404.html;
        error_page 502 /502.html;

        location = /404.html {
            return 404 '{"status": 404, "message": "Not Found"}';
            default_type application/json;
        }

        location = /502.html {
            return 502 '{"status": 502, "message": "Bad Gateway"}';
            default_type application/json;
        }
    }
}
