events {}

http {
    upstream admin-backend {
        server admin-service:8080;
    }

    upstream inventory-backend {
        server inventory-service:8081;
    }

    upstream products-backend {
        server product-catalog-service:8082;
    }

    upstream orders-backend {
        server order-management-service:8084;
    }

    upstream data-access-backend {
        server data-access-service:8085;
    }

    upstream auth-backend {
        server auth-service:8086;
    }

    server {
        listen 80;

        # Add new admin price management routes - protected by auth
        location /admin/prices {
            auth_request /auth/check;
            proxy_pass http://inventory-backend/admin/prices;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        location /admin/prices/update {
            auth_request /auth/check;
            proxy_pass http://inventory-backend/admin/prices/update;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        # Admin routes - all admin routes go to admin-backend
        location /admin/ {
            auth_request /auth/check;
            proxy_pass http://admin-backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        # Authentication routes
        location ~ ^/(login|register|logout) {
            proxy_pass http://auth-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Session cookie handling
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
        }

        # Protected inventory endpoint - auth-service will handle authentication check
        location /inventory {
            # Auth check is handled by auth-service
            auth_request /auth/check;
            # If authenticated, proxy to inventory service
            proxy_pass http://inventory-backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Session cookie handling
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;

            # If not authenticated, redirect to login
            error_page 401 = @error401;
        }

        # Authentication check endpoint
        location = /auth/check {
            internal;
            proxy_pass http://auth-backend/auth/check;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Cookie $http_cookie;
        }

        # Get current user endpoint
        location = /auth/user {
            proxy_pass http://auth-backend/auth/user;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
        }

        # Handle 401 errors by redirecting to login
        location @error401 {
            return 302 /login;
        }

        # Root location - redirect to login page
        location = / {
            return 301 /login;
        }



        location /farmers {
            auth_request /auth/check;
            proxy_pass http://inventory-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        location /products/ {
            auth_request /auth/check;
            proxy_pass http://products-backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        location /orders/ {
            auth_request /auth/check;
            proxy_pass http://orders-backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        location /orders {
            auth_request /auth/check;
            proxy_pass http://orders-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        location /data/ {
            auth_request /auth/check;
            proxy_pass http://data-access-backend/api/data/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }

        # Updated catalog and checkout locations - protected by auth
        location ~ ^/(catalog|checkout) {
            auth_request /auth/check;
            proxy_pass http://products-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            proxy_cookie_path / /;
            error_page 401 = @error401;
        }
    }
}
